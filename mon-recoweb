#!/usr/bin/env bash
# mon-recoweb (lite, 2 filtres, exécution ffuf visible + logs, tolérant au code 1)
# -----------------------------------------------------------------------------------------
# 1) whatweb (CMS/technos)
# 2) ffuf (répertoires)  : filtre appris sur .../RANDOM_DIR/
# 3) ffuf (fichiers)     : filtre appris sur .../RANDOM_FILE.php
# -mc all -k, threads réglables, rate optionnel
# Résultats : ./mon-recoweb_<target>/ + logs visibles
# Dépendances : whatweb, ffuf, curl, awk, sed
# -----------------------------------------------------------------------------------------
# SIG: mon-recoweb vLite-2filters-2025-09-05-b

set -euo pipefail
set -o pipefail

# Couleurs (coupées si pas TTY)
if [[ -t 1 ]]; then
  C_RST=$'\e[0m'; C_B=$'\e[1m'; C_G=$'\e[32m'; C_Y=$'\e[33m'; C_C=$'\e[36m'; C_R=$'\e[31m'
else
  C_RST=''; C_B=''; C_G=''; C_Y=''; C_C=''; C_R=''
fi

TARGET=""
WORDLIST="/usr/share/wordlists/dirb/common.txt"
EXTS="php,txt,html"
THREADS=40
RATE=""
OUTDIR=""
VERBOSE=false
NOFILTER=false
FORCE_HTTP=false
FORCE_HTTPS=false

usage() {
cat <<EOF
${C_B}Usage:${C_RST} mon-recoweb -t <IP|HOST|URL> [options]

  -t <target>     IP/host ou URL (avec/sans schéma)
  -w <wordlist>   Wordlist (def: ${WORDLIST})
  -x <exts>       Extensions fichiers (def: ${EXTS})
  -T <threads>    Threads ffuf (def: ${THREADS})
  -p <rate>       Tempo ffuf, ex: 50ms (facultatif)
  -o <outdir>     Dossier de sortie (def: auto, sans timestamp)
  -v              Verbose (affiche les commandes lancées)
  --http          Forcer HTTP
  --https         Forcer HTTPS
  --no-filter     Désactive les filtres auto (-fs)

Exemples:
  mon-recoweb -t site.htb
  mon-recoweb -t site.htb -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
  mon-recoweb -t https://site.htb -x php,txt
EOF
}

log() { echo -e "${C_C}[i]${C_RST} $*"; }
ok()  { echo -e "${C_G}[✓]${C_RST} $*"; }
warn(){ echo -e "${C_Y}[!]${C_RST} $*"; }
err() { echo -e "${C_R}[✗]${C_RST} $*" >&2; }

# Parse args
while [[ $# -gt 0 ]]; do
  case "$1" in
    -t) TARGET="$2"; shift 2 ;;
    -w) WORDLIST="$2"; shift 2 ;;
    -x) EXTS="$2"; shift 2 ;;
    -T) THREADS="$2"; shift 2 ;;
    -p) RATE="$2"; shift 2 ;;
    -o) OUTDIR="$2"; shift 2 ;;
    -v) VERBOSE=true; shift ;;
    --http)  FORCE_HTTP=true; shift ;;
    --https) FORCE_HTTPS=true; shift ;;
    --no-filter) NOFILTER=true; shift ;;
    -h|--help) usage; exit 0 ;;
    *) err "Option inconnue: $1"; usage; exit 1 ;;
  esac
done

# === DEBUG VERBEUX ===
if $VERBOSE; then
  set -x                      # trace chaque commande exécutée
  PS4='+ ${BASH_SOURCE}:${LINENO}:${FUNCNAME[0]}: '  # montre le n° de ligne
fi

[[ -z "${TARGET}" ]] && { err "Cible manquante (-t)."; usage; exit 1; }
[[ ! -f "${WORDLIST}" ]] && { err "Wordlist introuvable: ${WORDLIST}"; exit 1; }
command -v whatweb >/dev/null 2>&1 || { err "whatweb manquant"; exit 1; }
command -v ffuf    >/dev/null 2>&1 || { err "ffuf manquant"; exit 1; }

# ---------- Dossier sortie (sans timestamp) ----------
SAFE_TGT="$(echo "${TARGET}" | sed 's#[/:]#_#g')"
OUTDIR="${OUTDIR:-mon-recoweb_${SAFE_TGT}}"
mkdir -p "${OUTDIR}"
ok "Dossier de travail: ${OUTDIR}"

# ---------- Détermination schéma ----------
base_host="${TARGET}"
if [[ "${TARGET}" =~ ^https?:// ]]; then
  BASE_URL="${TARGET%/}"
  base_host="$(echo "${TARGET}" | sed -E 's#^https?://##' | cut -d/ -f1)"
else
  if ${FORCE_HTTP}; then
    BASE_URL="http://${TARGET}"
  elif ${FORCE_HTTPS}; then
    BASE_URL="https://${TARGET}"
  else
    if curl -k -sI "https://${TARGET}" >/dev/null 2>&1; then
      BASE_URL="https://${TARGET}"
    else
      BASE_URL="http://${TARGET}"
    fi
  fi
fi
ok "Base URL : ${BASE_URL}"

# ---------- 1) WHATWEB ----------
log "WhatWeb (-a 3)…"
whatweb -a 3 "${BASE_URL}" | sed -r 's/\x1B\[[0-9;]*[A-Za-z]//g' | tee "${OUTDIR}/whatweb.txt"
whatweb -a 3 "${BASE_URL}" --log-json="${OUTDIR}/whatweb.json" >/dev/null 2>&1 || true
[[ ! -s "${OUTDIR}/whatweb.txt" ]] && warn "whatweb.txt est vide"

# ---------- 2 filtres séparés (taille 404) ----------
DIR_FILTER=""
FILE_FILTER=""
if ! ${NOFILTER}; then
  RANDDIR="__dir__$(tr -dc 'a-z0-9' </dev/urandom | head -c 10)/"
  URL_DIR="${BASE_URL}/${RANDDIR}"
  SIZE_DIR="$(curl -k -s -o /dev/null -w '%{size_download}\n' "${URL_DIR}" || echo "0")"

  RANDFILE="__file__$(tr -dc 'a-z0-9' </dev/urandom | head -c 10).php"
  URL_FILE="${BASE_URL}/${RANDFILE}"
  SIZE_FILE="$(curl -k -s -o /dev/null -w '%{size_download}\n' "${URL_FILE}" || echo "0")"

  [[ "${SIZE_DIR}"  != "0" ]] && DIR_FILTER="-fs ${SIZE_DIR}"
  [[ "${SIZE_FILE}" != "0" ]] && FILE_FILTER="-fs ${SIZE_FILE}"

  log "Taille 'bruit' DIR  : ${SIZE_DIR}  (test: ${URL_DIR})"
  log "Taille 'bruit' FILE : ${SIZE_FILE} (test: ${URL_FILE})"
else
  warn "Filtres auto désactivés (--no-filter)"
fi

# ---------- Helpers ----------
run_ffuf () {
  local label="$1" out_csv="$2" exts_param="$3" size_filter="$4" out_log="$5"

  local cmd=( ffuf
    -u "${BASE_URL}/FUZZ"
    -w "${WORDLIST}"
    -mc all
    -k
    -t "${THREADS}"
    -of csv -o "${out_csv}"
  )
  [[ -n "${RATE}" ]]        && cmd+=( -p "${RATE}" )
  [[ -n "${size_filter}" ]] && cmd+=( ${size_filter} )
  [[ -n "${exts_param}"  ]] && cmd+=( -x "${exts_param}" )

  echo
  log "=== DÉBUT ffuf (${label}) ==="
  echo "[CMD] ${cmd[*]}"
  echo "[LOG] ${out_log}"
  echo "[CSV] ${out_csv}"

  # Exécution tolérante : on ne quitte pas sur code 1
  set +e
  "${cmd[@]}" >"${out_log}" 2>&1
  local ffuf_status=$?
  set -e

  {
    echo
    echo "-----"
    echo "ffuf terminé avec code: ${ffuf_status}"
    echo "Heure: $(date)"
  } >> "${out_log}"

  if [[ ${ffuf_status} -ge 2 ]]; then
    err "ffuf (${label}) a échoué (code ${ffuf_status}). Regarde ${out_log}"
  elif [[ ${ffuf_status} -eq 1 ]]; then
    warn "ffuf (${label}) a tourné mais n'a trouvé aucun résultat (code 1). Voir ${out_log}"
  else
    ok "ffuf (${label}) a tourné correctement (code 0)."
  fi

  # Assure la présence d'un CSV (vide avec header si besoin)
  if [[ ! -f "${out_csv}" ]]; then
    echo "time,url,redirectlocation,status,length,words,lines" > "${out_csv}"
    echo "[i] CSV manquant créé vide: ${out_csv}" >> "${out_log}"
  fi
}

summarize_csv () {
  local csv="$1" summary="$2"
  if [[ -s "${csv}" ]]; then
    awk -F',' 'NR==1 {next} {printf "%-4s  len=%-7s  %s\n", $4, $5, $2}' "${csv}" \
      | sed 's|"||g' | sort -u > "${summary}"
  else
    : > "${summary}"
  fi
}

# ---------- 2) FFUF — RÉPERTOIRES ----------
CSV_DIRS="${OUTDIR}/ffuf_dirs.csv"
LOG_DIRS="${OUTDIR}/ffuf_dirs.log"
SUMMARY_DIRS="${OUTDIR}/summary_dirs.txt"
run_ffuf "répertoires" "${CSV_DIRS}" "" "${DIR_FILTER}" "${LOG_DIRS}"
summarize_csv "${CSV_DIRS}" "${SUMMARY_DIRS}"

# ---------- 3) FFUF — FICHIERS ----------
CSV_FILES="${OUTDIR}/ffuf_files.csv"
LOG_FILES="${OUTDIR}/ffuf_files.log"
SUMMARY_FILES="${OUTDIR}/summary_files.txt"
run_ffuf "fichiers (${EXTS})" "${CSV_FILES}" "${EXTS}" "${FILE_FILTER}" "${LOG_FILES}"
summarize_csv "${CSV_FILES}" "${SUMMARY_FILES}"

# ---------- Affichage clair ----------
echo
echo -e "${C_B}=== RÉPERTOIRES TROUVÉS (scan sans extensions) ===${C_RST}"
if [[ -s "${SUMMARY_DIRS}" ]]; then
  grep -E '^(301|302|401|403|200|500)' "${SUMMARY_DIRS}" || true
  grep -Ev '^(301|302|401|403|200|500)' "${SUMMARY_DIRS}" || true
else
  echo "(aucun résultat)"
fi

echo
echo -e "${C_B}=== FICHIERS TROUVÉS (scan avec extensions: ${EXTS}) ===${C_RST}"
if [[ -s "${SUMMARY_FILES}" ]]; then
  grep -E '^(301|302|401|403|200|500)' "${SUMMARY_FILES}" || true
  grep -Ev '^(301|302|401|403|200|500)' "${SUMMARY_FILES}" || true
else
  echo "(aucun résultat)"
fi

echo
ok "Recon web (lite, 2 filtres) terminé."
echo -e "  → Dossier : ${C_B}${OUTDIR}${C_RST}"
echo "    - whatweb.txt | whatweb.json"
echo "    - ffuf_dirs.csv | ffuf_dirs.log | summary_dirs.txt"
echo "    - ffuf_files.csv | ffuf_files.log | summary_files.txt"
