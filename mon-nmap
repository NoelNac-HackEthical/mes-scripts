#!/bin/bash
# mon-nmap ‚Äî Scan Nmap ‚Äúagressif‚Äù uniquement (sC+sV+OS+traceroute)
# - √âtapes: [1] TCP ports -> [3] Aggressive (-A) -> [4] UDP (optionnel)
# - Affichage OS : une seule fois au terminal (pas de doublon dans summary.txt)
# - UDP √† l‚Äô√©cran : affich√© seulement s‚Äôil existe au moins un vrai "udp open"
# - Summary : jamais d‚Äôopen|filtered

set -euo pipefail

# === Version / Aide ==========================================================
VERSION="mon-nmap v2025.09.04-aggr-only"
if [[ "${1:-}" == "--version" ]]; then
  echo "$VERSION"
  exit 0
fi
if [[ "${1:-}" == "--help" ]]; then
  cat <<EOF
$VERSION
Usage: $(basename "$0") [--udp-all] <IP_CIBLE>

Options:
  --udp-all     Scan UDP complet (-p-) au lieu du top 20
  --version     Afficher la version
  --help        Afficher cette aide
EOF
  exit 0
fi

# === Couleurs ================================================================
RED='\033[1;31m'; GREEN='\033[1;32m'; YELLOW='\033[1;33m'
CYAN='\033[1;36m'; BLUE='\033[1;34m'; BOLD='\033[1m'; NC='\033[0m'

# === Option : --udp-all ======================================================
FULL_UDP=false
if [[ "${1:-}" == "--udp-all" ]]; then
  FULL_UDP=true
  shift
fi

# === Argument : IP cible =====================================================
if [ "$#" -ne 1 ]; then
  echo -e "${RED}‚ùå Usage: ${BOLD}$(basename "$0") [--udp-all] <IP_CIBLE>${NC}"
  exit 1
fi
IP=$1

# === Dossiers / fichiers =====================================================
DOSSIER="nmap_$IP"
mkdir -p "$DOSSIER"
F1="$DOSSIER/1-port_scan.txt"
F3="$DOSSIER/3-aggressive_scan.txt"
F4="$DOSSIER/4-udp_scan.txt"
FSUM="$DOSSIER/summary.txt"

START_TIME=$SECONDS
echo -e "${BLUE}üîç Initialisation du scan Nmap sur ${BOLD}$IP${NC}"

# === [1] Full TCP port scan ==================================================
echo -e "${YELLOW}[1] Scan de tous les ports TCP (1-65535)...${NC}"
nmap -p- --min-rate 10000 -T4 --max-retries 3 -oN "$F1" "$IP" > /dev/null 2>&1

# Ports TCP ouverts (open strict)
PORTS=$(LC_ALL=C grep -E '^[[:space:]]*[0-9]+/tcp[[:space:]]+open([[:space:]]|$)' "$F1" \
        | cut -d'/' -f1 | tr '\n' ',' | sed 's/,$//')
if [ -z "$PORTS" ]; then
  echo -e "${RED}‚ùå Aucun port TCP ouvert d√©tect√©.${NC}"
  exit 1
fi
echo -e "${GREEN}‚úî Ports TCP d√©tect√©s : ${BOLD}$PORTS${NC}"

# === [3] Scan agressif (inclut sC + sV + OS + traceroute) ===================
echo -e "${YELLOW}[3] Scan agressif avec d√©tection OS (-A)...${NC}"
nmap -A -T4 -p"$PORTS" --max-retries 3 -oN "$F3" "$IP" > /dev/null 2>&1

# === [4] UDP (rapide par d√©faut) ============================================
if $FULL_UDP; then
  echo -e "${YELLOW}[4] Scan UDP complet (-p-)...${NC}"
  nmap -sU -p- -T4 --max-retries 3 --scan-delay 5ms --host-timeout 20m -oN "$F4" "$IP"
else
  echo -e "${YELLOW}[4] Scan UDP rapide (top 20 ports)...${NC}"
  nmap -sU --top-ports 20 -T4 --max-retries 2 --host-timeout 10m -oN "$F4" "$IP" > /dev/null 2>&1
fi
echo -e "${GREEN}‚úî Scan UDP termin√©.${NC}"

echo -e "${GREEN}${BOLD}‚úî Tous les scans sont termin√©s !${NC}"

# === R√©sum√© TCP (√† l‚Äô√©cran) depuis l‚Äôaggressif ===============================
echo -e "\n${CYAN}${BOLD}üìÑ R√âSUM√â DES SERVICES TCP D√âTECT√âS :${NC}\n"
i=1; inside_block=false
while IFS= read -r line; do
  if [[ "$line" =~ ^[0-9]+/tcp[[:space:]]+open([[:space:]]|$) ]]; then
    printf "  [#%d] " "$i"
    echo -e "$line"
    i=$((i+1))
    inside_block=true
  elif [[ "$inside_block" == true && "$line" =~ ^[\|_] ]]; then
    line=${line#|_}; line=${line#|}
    echo -e "      ‚Üí ${line}"
  else
    inside_block=false
  fi
done < "$F3"

# === UDP √† l‚Äô√©cran : seulement s'il existe au moins un vrai "udp open" ======
UDP_OPEN_ONLY="$(LC_ALL=C grep -E '^[[:space:]]*[0-9]+/udp[[:space:]]+open([[:space:]]|$)' "$F4" || true)"
if [[ -n "$UDP_OPEN_ONLY" ]]; then
  echo -e "\n${CYAN}${BOLD}üìÑ R√âSUM√â DES SERVICES UDP D√âTECT√âS :${NC}\n"
  echo "$UDP_OPEN_ONLY" | nl -w2 -s'. ' | while read -r line; do
    NUM=$(echo "$line" | cut -d'.' -f1)
    printf "  [#%s] %s\n" "$NUM" "$(echo "$line" | cut -d' ' -f2-)"
  done
fi

# === D√©tection OS (affich√©e une seule fois au terminal) =====================
OS_LINE="$(grep -i 'OS details:' "$F3" | head -n1 | sed 's/OS details:[[:space:]]*//I')"
if [[ -n "$OS_LINE" ]]; then
  echo -e "\n${BLUE}${BOLD}üñ•Ô∏è  D√©tection du syst√®me d‚Äôexploitation :${NC} $OS_LINE"
else
  echo -e "\n${BLUE}üñ•Ô∏è  OS non identifi√© par Nmap.${NC}"
fi

# === SUMMARY (sans doublon d‚ÄôOS) =============================================
{
  echo "==== R√©sum√© $IP ($(date '+%F %T')) ===="
  echo

  # 1) Ports TCP ouverts (depuis le full port scan)
  if [[ -s "$F1" ]]; then
    echo "[1-port_scan] TCP open :"
    LC_ALL=C grep -E '^[[:space:]]*[0-9]+/tcp[[:space:]]+open([[:space:]]|$)' "$F1"
    echo
  fi

  # 3) D√©tails depuis l‚Äôaggressif (open strict)
  if [[ -s "$F3" ]]; then
    echo "[3-aggressive_scan] D√©tails (open) :"
    LC_ALL=C grep -E '^[[:space:]]*[0-9]+/(tcp|udp)[[:space:]]+open([[:space:]]|$)' "$F3"
    echo
    # ‚ö†Ô∏è Pas de "OS: ..." ici pour √©viter le double affichage
  fi

  # 4) UDP ouverts (uniquement si "open" strict)
  if [[ -n "$UDP_OPEN_ONLY" ]]; then
    echo "[4-udp_scan] UDP ouverts :"
    echo "$UDP_OPEN_ONLY"
    echo
  fi

  # CSV utiles
  TCP_CSV="$(LC_ALL=C grep -E '^[[:space:]]*[0-9]+/tcp[[:space:]]+open([[:space:]]|$)' "$F3" | cut -d'/' -f1 | paste -sd, - 2>/dev/null || true)"
  [[ -n "${TCP_CSV:-}" ]] && { echo "TCP open (CSV) : $TCP_CSV"; echo; }

  if [[ -n "$UDP_OPEN_ONLY" ]]; then
    UDP_CSV="$(echo "$UDP_OPEN_ONLY" | cut -d'/' -f1 | paste -sd, - 2>/dev/null || true)"
    [[ -n "${UDP_CSV:-}" ]] && { echo "UDP open (CSV) : $UDP_CSV"; echo; }
  fi
} > "$FSUM"

# === Fin =====================================================================
ELAPSED=$((SECONDS - START_TIME)); MINS=$((ELAPSED/60)); SECS=$((ELAPSED%60))
echo -e "\n${CYAN}üßæ  R√©sum√© rapide :${NC} ${BOLD}$FSUM${NC}"
echo -e "${BLUE}üìÅ R√©sultats complets : ${BOLD}$DOSSIER/${NC}"
echo -e "${GREEN}‚è±Ô∏è  Dur√©e totale du scan : ${BOLD}${MINS}m ${SECS}s${NC}"
