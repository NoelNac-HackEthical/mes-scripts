#!/bin/bash
# NAME=mon-nmap
# VERSION=1.0.4
# DESCRIPTION=Automatise une s√©rie de scans Nmap (TCP full, scan agressif, UDP) et g√©n√®re des r√©sum√©s texte et Markdown pr√™ts pour les writeups CTF.
# PRESENTATION_START
# Mon-Nmap ‚Äî Outil d'√©num√©ration Nmap pour CTF / pentest
#
# Ce script automatise la s√©quence de scans que j'ex√©cute syst√©matiquement en phase
# d'√©num√©ration d'un challenge HTB : scan TCP complet (1-65535), scan "aggressif" (-A)
# sur les ports d√©tect√©s, et scan UDP (top-20 ou complet via --udp-all).
#
# Objectifs p√©dagogiques et pratiques :
# - standardiser la collecte d'informations initiale afin d'avoir des r√©sultats comparables
#   d'une machine √† l'autre ;
# - produire des sorties synth√©tiques pr√™tes √† √™tre ins√©r√©es dans un writeup
#   (`summary.txt` brut + `summary.md` √©pur√© pour Hugo) ;
# - comportement conservateur : le script cr√©e un dossier de r√©sultats `nmap_<cible>`
#   (ex. `nmap_mon-site.htb`) et y place tous les fichiers de sortie ‚Äî il n'√©crase
#   rien en dehors de ce dossier.
#
# Points notables :
# - option `--udp-all` : lance un scan UDP complet (-p-) au lieu du top 20 ;
# - les fichiers produits : 1-port_scan.txt, 2-aggressive_scan.txt, 3-udp_scan.txt,
#   summary.txt (brut), summary.md (version markdown et synth√©tique) ;
# - usage type : `./mon-nmap mon-site.htb` ou `./mon-nmap --udp-all mon-site.htb`
# PRESENTATION_END
# mon-nmap ‚Äî scan agressif (-A) + summary.txt et summary.md (Hugo, sans emojis)
# √âtapes : [1] TCP full -> [2] Aggressive (-A) -> [3] UDP (optionnel)
# R√®gles : on ignore 'open|filtered' (on ne garde que 'udp ... open' strict)

set -euo pipefail

# --- version helpers ---
# Usage: mettre ce bloc en t√™te du script. Appel: --version d√©clenche _print_version_and_exit
_self_path="${BASH_SOURCE[0]:-$0}"
# si possible r√©soudre les symlinks pour afficher le nom r√©el du fichier
if command -v readlink >/dev/null 2>&1; then
  _resolved="$(readlink -f -- "$_self_path" 2>/dev/null || true)"
  [ -n "$_resolved" ] && _self_path="$_resolved"
fi
_self_base="$(basename "$_self_path")"

_version_str() {
  # r√©cup√®re la premi√®re ligne '# VERSION=...' (tol√®re espaces autour de '=' et CRLF)
  # awk lit le fichier et renvoie la partie droite de '=' ; gsub retire CR si pr√©sent
  local v
  v="$(awk -F= '/^# *VERSION *=/ { gsub(/\r$/,"",$2); print $2; exit }' "$_self_path" 2>/dev/null || true)"
  [ -n "$v" ] || v="0.0.0"
  printf '%s %s\n' "$_self_base" "$v"
}

_print_version_and_exit() { _version_str; exit 0; }
# -----------------------

usage(){
  cat <<USAGE
Usage: $(basename "$0") [--udp-all] <IP_CIBLE>

Options:
  --udp-all     Scan UDP complet (-p-) au lieu du top 20
  -V, --version Afficher la version
  -h, --help    Afficher cette aide
USAGE
}


if [[ "${1:-}" == "--version" || "${1:-}" == "-V" ]]; then
  _print_version_and_exit
fi

if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
  _version_str
  usage
  exit 0
fi

# Couleurs (terminal)
RED='\033[1;31m'; GREEN='\033[1;32m'; YELLOW='\033[1;33m'
CYAN='\033[1;36m'; BLUE='\033[1;34m'; BOLD='\033[1m'; NC='\033[0m'

# Option : --udp-all
FULL_UDP=false
if [[ "${1:-}" == "--udp-all" ]]; then FULL_UDP=true; shift; fi

# IP cible
if [ "$#" -ne 1 ]; then
  echo -e "${RED}‚ùå Usage: ${BOLD}$(basename "$0") [--udp-all] <IP_CIBLE>${NC}"
  exit 1
fi
IP=$1

# Dossiers/fichiers
DOSSIER="nmap_$IP"
mkdir -p "$DOSSIER"
F1="$DOSSIER/1-port_scan.txt"
F2="$DOSSIER/2-aggressive_scan.txt"
F3="$DOSSIER/3-udp_scan.txt"
FSUM_TXT="$DOSSIER/summary.txt"
FSUM_MD="$DOSSIER/summary.md"

START_TIME=$SECONDS
echo -e "${BLUE}üîç Initialisation du scan Nmap sur ${BOLD}$IP${NC}"

# [1] TCP full port scan
echo -e "${YELLOW}[1] Scan de tous les ports TCP (1-65535)...${NC}"
nmap -p- --min-rate 10000 -T4 --max-retries 3 -oN "$F1" "$IP" > /dev/null 2>&1
TCP_OPEN_LINES="$(LC_ALL=C grep -E '^[[:space:]]*[0-9]+/tcp[[:space:]]+open([[:space:]]|$)' "$F1" || true)"
PORTS="$(printf '%s\n' "$TCP_OPEN_LINES" | cut -d'/' -f1 | paste -sd, - 2>/dev/null || true)"
if [[ -z "${PORTS:-}" ]]; then
  echo -e "${RED}‚ùå Aucun port TCP ouvert d√©tect√©.${NC}"
  exit 1
fi
echo -e "${GREEN}‚úî Ports TCP d√©tect√©s : ${BOLD}$PORTS${NC}"

# [2] Aggressive (-A)
echo -e "${YELLOW}[2] Scan agressif avec d√©tection OS (-A)...${NC}"
nmap -A -T4 -p"$PORTS" --max-retries 3 -oN "$F2" "$IP" > /dev/null 2>&1

# [3] UDP
if $FULL_UDP; then
  echo -e "${YELLOW}[3] Scan UDP complet (-p-)...${NC}"
  nmap -sU -p- -T4 --max-retries 3 --scan-delay 5ms --host-timeout 20m -oN "$F3" "$IP"
else
  echo -e "${YELLOW}[3] Scan UDP top 20...${NC}"
  nmap -sU --top-ports 20 -T4 --max-retries 2 --host-timeout 10m -oN "$F3" "$IP" > /dev/null 2>&1
fi
echo -e "${GREEN}‚úî Scan UDP termin√©.${NC}"
echo -e "${GREEN}${BOLD}‚úî Tous les scans sont termin√©s !${NC}"

# Extractions
OS_LINE="$(grep -i 'OS details:' "$F2" | head -n1 | sed 's/OS details:[[:space:]]*//I')"
UDP_OPEN_ONLY="$(LC_ALL=C grep -E '^[[:space:]]*[0-9]+/udp[[:space:]]+open([[:space:]]|$)' "$F3" || true)"
TCP_OPEN_FROM_F2="$(LC_ALL=C grep -E '^[[:space:]]*[0-9]+/tcp[[:space:]]+open([[:space:]]|$)' "$F2" || true)"
TCP_CSV="$(printf '%s\n' "$TCP_OPEN_FROM_F2" | cut -d'/' -f1 | paste -sd, - 2>/dev/null || true)"
UDP_CSV=""
[[ -n "$UDP_OPEN_ONLY" ]] && UDP_CSV="$(printf '%s\n' "$UDP_OPEN_ONLY" | cut -d'/' -f1 | paste -sd, - 2>/dev/null || true)"

# Affichage terminal (inchang√©)
echo -e "\n${CYAN}${BOLD}üìÑ R√âSUM√â DES SERVICES TCP D√âTECT√âS :${NC}\n"
i=1; inside_block=false
while IFS= read -r line; do
  if [[ "$line" =~ ^[0-9]+/tcp[[:space:]]+open([[:space:]]|$) ]]; then
    printf "  [#%d] %s\n" "$i" "$line"
    i=$((i+1)); inside_block=true
  elif [[ "$inside_block" == true && "$line" =~ ^[\|_] ]]; then
    line=${line#|_}; line=${line#|}; printf "      ‚Üí %s\n" "$line"
  else
    inside_block=false
  fi
done < "$F2"

if [[ -n "$UDP_OPEN_ONLY" ]]; then
  echo -e "\n${CYAN}${BOLD}üìÑ R√âSUM√â DES SERVICES UDP D√âTECT√âS :${NC}\n"
  echo "$UDP_OPEN_ONLY" | nl -w2 -s'. ' | while read -r line; do
    NUM=$(echo "$line" | cut -d'.' -f1)
    printf "  [#%s] %s\n" "$NUM" "$(echo "$line" | cut -d' ' -f2-)"
  done
fi

if [[ -n "$OS_LINE" ]]; then
  echo -e "\n${BLUE}${BOLD}üñ•Ô∏è  D√©tection du syst√®me d‚Äôexploitation :${NC} $OS_LINE"
else
  echo -e "\n${BLUE}üñ•Ô∏è  OS non identifi√© par Nmap.${NC}"
fi

# summary.txt (brut, inchang√©)
{
  echo "==== R√©sum√© $IP ($(date '+%F %T')) ===="
  echo
  echo "[1-port_scan] TCP open :"
  [[ -n "$TCP_OPEN_LINES" ]] && echo "$TCP_OPEN_LINES"
  echo
  echo "[2-aggressive_scan] D√©tails (open) :"
  LC_ALL=C grep -E '^[[:space:]]*[0-9]+/(tcp|udp)[[:space:]]+open([[:space:]]|$)' "$F2" || true
  echo
  if [[ -n "$OS_LINE" ]]; then
    echo "OS: $OS_LINE"
    echo
  fi
  if [[ -n "$UDP_OPEN_ONLY" ]]; then
    echo "[3-udp_scan] UDP ouverts :"
    echo "$UDP_OPEN_ONLY"
    echo
  fi
  echo "R√©sum√© des services d√©tect√©s (TCP) :"
  i=1; inside_block=false
  while IFS= read -r line; do
    if [[ "$line" =~ ^[0-9]+/tcp[[:space:]]+open([[:space:]]|$) ]]; then
      printf "  [#%d] %s\n" "$i" "$line"
      i=$((i+1)); inside_block=true
    elif [[ "$inside_block" == true && "$line" =~ ^[\|_] ]]; then
      line=${line#|_}; line=${line#|}; printf "      ‚Üí %s\n" "$line"
    else
      inside_block=false
    fi
  done < "$F2"
  echo
  [[ -n "$TCP_CSV" ]] && { echo "TCP open (CSV) : $TCP_CSV"; echo; }
  [[ -n "$UDP_CSV" ]] && { echo "UDP open (CSV) : $UDP_CSV"; echo; }
} > "$FSUM_TXT"

# summary.md (Hugo) ‚Äî √©pur√© (info non redondante)
{
  echo "### Scan initial"
  echo

  # ---- Services d√©tect√©s (TCP) √©pur√©s ----
  echo "#### Services d√©tect√©s"
  # On parcourt F2 et on synth√©tise par port: ligne principale + d√©tails utiles condens√©s
  i=1
  in_block=false
  have_sshhk=0; ssh_types=""
  http_title=""; server_hdr=""; ssl_cn=""
  current_main=""

  flush_item() {
    if [[ -n "${current_main:-}" ]]; then
      echo "$i. **$current_main**"
      [[ -n "$http_title" ]] && echo "   ‚Üí http-title: $http_title  "
      [[ -n "$server_hdr" ]] && echo "   ‚Üí http-server-header: $server_hdr  "
      [[ -n "$ssl_cn"    ]] && echo "   ‚Üí ssl-cert CN: $ssl_cn  "
      if [[ $have_sshhk -eq 1 ]]; then
        ssh_types_clean="$(echo "$ssh_types" | tr '[:lower:]' '[:upper:]' | sed 's/ \{1,\}/ /g; s/^, *//; s/, *,/, /g')"
        echo "   ‚Üí ssh-hostkey: $ssh_types_clean  "
      fi
      echo
      i=$((i+1))
    fi
    current_main=""
    in_block=false
    have_sshhk=0; ssh_types=""
    http_title=""; server_hdr=""; ssl_cn=""
  }

  while IFS= read -r line; do
    if [[ "$line" =~ ^[0-9]+/tcp[[:space:]]+open([[:space:]]|$) ]]; then
      flush_item
      current_main="$line"
      in_block=true
      continue
    fi
    if $in_block && [[ "$line" =~ ^[\|_] ]]; then
      sub="${line#|_}"; sub="${sub#|}"; sub="${sub#" "}"
      if [[ "$sub" =~ ^ssh-hostkey: ]]; then
        have_sshhk=1
      elif [[ $have_sshhk -eq 1 ]]; then
        if [[ "$sub" =~ \(RSA\) ]]; then ssh_types="$ssh_types, RSA"; fi
        if [[ "$sub" =~ \(ECDSA\) ]]; then ssh_types="$ssh_types, ECDSA"; fi
        if [[ "$sub" =~ \(ED25519\) ]]; then ssh_types="$ssh_types, ED25519"; fi
      elif [[ "$sub" =~ ^http-title: ]]; then
        http_title="$(echo "$sub" | sed 's/^http-title:[[:space:]]*//')"
      elif [[ "$sub" =~ ^http-server-header: ]]; then
        server_hdr="$(echo "$sub" | sed 's/^http-server-header:[[:space:]]*//')"
      elif [[ "$sub" =~ ^ssl-cert: ]]; then
        if [[ "$sub" =~ commonName=([^/[:space:]]+) ]]; then
          ssl_cn="${BASH_REMATCH[1]}"
        elif [[ "$sub" =~ CN=([^/[:space:]]+) ]]; then
          ssl_cn="${BASH_REMATCH[1]}"
        fi
      elif [[ "$sub" =~ ^Subject: ]]; then
        if [[ "$sub" =~ commonName=([^/[:space:]]+) ]]; then
          ssl_cn="${BASH_REMATCH[1]}"
        elif [[ "$sub" =~ CN=([^/[:space:]]+) ]]; then
          ssl_cn="${BASH_REMATCH[1]}"
        fi
      fi
    else
      in_block=false
    fi
  done < "$F2"
  flush_item

  echo "#### OS d√©tect√©"
  if [[ -n "$OS_LINE" ]]; then
    echo "\`$OS_LINE\`"
  else
    echo "\`Non identifi√©\`"
  fi
  echo

  echo "#### UDP"
  if [[ -n "$UDP_CSV" ]]; then
    echo "- Ports ouverts (CSV) : \`$UDP_CSV\`"
  else
    if $FULL_UDP; then
      echo "*(aucun port \`open\` strict d√©tect√© ; scan complet \`-p-\`)*"
    else
      echo "*(aucun port \`open\` strict d√©tect√© ; scan top 20)*"
    fi
  fi
  echo

  echo "#### Vue synth√©tique"
  echo "- **TCP ouverts :** \`${TCP_CSV:-}\`"
  if [[ -n "$UDP_CSV" ]]; then
    echo "- **UDP ouverts :** \`${UDP_CSV}\`"
  else
    echo "- **UDP ouverts :** *(aucun open strict)*"
  fi
} > "$FSUM_MD"

ELAPSED=$((SECONDS - START_TIME)); MINS=$((ELAPSED/60)); SECS=$((ELAPSED%60))
echo -e "\n${CYAN}üßæ  R√©sum√© texte :${NC} ${BOLD}$FSUM_TXT${NC}"
echo -e "${CYAN}üßæ  R√©sum√© Markdown :${NC} ${BOLD}$FSUM_MD${NC}"
echo -e "${BLUE}üìÅ R√©sultats complets : ${BOLD}$DOSSIER/${NC}"
echo -e "${GREEN}‚è±Ô∏è  Dur√©e totale du scan : ${BOLD}${MINS}m ${SECS}s${NC}"
