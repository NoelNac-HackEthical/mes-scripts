#!/usr/bin/env bash
# NAME=mon-nmap-dev
# VERSION=2.0.1
# DESCRIPTION=Automatise une série de scans Nmap (TCP complet, agressif, CMS, UDP) pour une cible CTF donnée.
# PRESENTATION_START
# mon-nmap — Scan Nmap “tout-en-un” pour CTF
#
# Ce script lance automatiquement plusieurs passes Nmap sur une cible (IP ou domaine) :
#
# - Scan TCP complet sur tous les ports (1-65535)
# - Scan agressif ciblé sur les ports ouverts (détection de services + scripts vulnérabilités “legacy”)
# - Scan orienté CMS (WordPress, Drupal, Joomla, etc.) sur les mêmes ports
# - Scan UDP rapide (top 20 ports)
#
# Tous les résultats sont stockés dans le répertoire `scans_nmap/` :
# - full_tcp_scan.txt
# - aggressive_vuln_scan.txt
# - cms_vuln_scan.txt
# - udp_vuln_scan.txt
#
# L’objectif est d’obtenir rapidement une base solide pour l’énumération et
# l’analyse des pistes d’exploitation sur une machine CTF.
# PRESENTATION_END
# HOMEPAGE=https://github.com/NoelNac-HackEthical/mes-scripts
#____________________________________________________________________________
#
# Bref résumé :
#   Automatise une série de scans Nmap (TCP complet, agressif, CMS, UDP) pour une cible CTF donnée.
#
set -euo pipefail

# ---------------------------------------------------------------------------
# Helpers version (ne pas modifier)
_self_path="${BASH_SOURCE[0]:-$0}"
if command -v readlink >/dev/null 2>&1; then
  _resolved="$(readlink -f -- "$_self_path" 2>/dev/null || true)"
  [ -n "$_resolved" ] && _self_path="$_resolved"
fi
_self_base="$(basename "$_self_path")"

_version_str(){
  # lit la première occurrence '# VERSION=' dans le fichier source (robuste CRLF)
  local v
  v="$(awk -F= '/^# *VERSION *=/ { gsub(/\r$/,"",$2); print $2; exit }' "$_self_path" 2>/dev/null || true)"
  v="${v:-0.0.0}"
  printf '%s v%s\n' "$_self_base" "$v"
}
_print_version_and_exit(){ _version_str; exit 0; }
# ---------------------------------------------------------------------------

# ---------------------------------------------------------------------------
# USAGE (heredoc)
usage(){
  cat <<USAGE
Usage: ${_self_base} [OPTIONS] <IP_OU_DOMAINE>

Lance une série de scans Nmap sur une cible (IP ou domaine) et enregistre
les résultats dans le répertoire scans_nmap/ :

  1) Scan complet des ports TCP
  2) Scan agressif orienté vulnérabilités (CTF-perfect LEGACY)
  3) Scan orienté CMS (WordPress, Drupal, Joomla...)
  4) Scan UDP (top 20 ports)

Fichiers produits :
  scans_nmap/full_tcp_scan.txt
  scans_nmap/aggressive_vuln_scan.txt
  scans_nmap/cms_vuln_scan.txt
  scans_nmap/udp_vuln_scan.txt

Options:
  -h, --help       Affiche cette aide
  -V, --version    Affiche la version
  --debug          Active le mode debug (set -x, verbosité bash)

Exemple:
  ${_self_base} 10.10.10.14
  ${_self_base} target.htb
USAGE
}
# ---------------------------------------------------------------------------

examples(){
  cat <<EXAMPLES
# Scan complet d'une machine CTF (IP directe)
${_self_base} 10.10.10.14

# Scan d'un domaine d'exercice
${_self_base} target.htb

# Avec debug bash pour voir les commandes exécutées
${_self_base} --debug 10.10.10.14
EXAMPLES
}
# ---------------------------------------------------------------------------

# ---------------------------------------------------------------------------
run_scans() {
  local target="$1"
  local output_dir="scans_nmap"

  # ---------- Pré-check canonique HTB : validation IP sans ICMP ----------
  if nc -z -w2 "$target" 80 2>/dev/null \
     || nc -z -w2 "$target" 443 2>/dev/null \
     || nc -z -w2 "$target" 22 2>/dev/null; then
    echo "[*] Pré-check IP OK : $target répond via TCP."
  else
    echo "[!] Aucune réponse TCP immédiate depuis $target."
    echo "[!] L'IP de $target estpeut être incorrecte (reset HTB ?)."
    echo "[!] Vérifie l'IP dans l'interface HTB"
    echo "[!] et /etc/hosts si tu utilises un nom de domaine."
    echo
    read -r -p "Continuer quand même le scan ? [o/N] " rep
    case "$rep" in
      [oOyY]) echo "[*] Poursuite du scan malgré l'incertitude sur l'IP." ;;
      *) echo "[!] Scan interrompu."; return 1 ;;
    esac
  fi

  # Création du répertoire de sortie
  mkdir -p "$output_dir"

  # ===== ÉTAPE 1: SCAN COMPLET DES PORTS TCP =====
  echo "[1/4] Scan complet des ports TCP sur $target..."
  nmap -Pn -p- --min-rate 5000 -T4 -oN "$output_dir/full_tcp_scan.txt" "$target"

  # ===== ÉTAPE 2: EXTRACTION DES PORTS OUVERTS =====
  local ports
  ports=$(grep -E '^[0-9]+/tcp.*open' "$output_dir/full_tcp_scan.txt" \
    | awk '{print $1}' \
    | cut -d'/' -f1 \
    | tr '\n' ',' \
    | sed 's/,$//')

  if [[ -z "$ports" ]]; then
    echo "[!] Aucun port TCP 'open' trouvé dans $output_dir/full_tcp_scan.txt"
  else
    echo "Ports ouverts: $ports"
  fi
  
  # ===== ÉTAPE 3: SCAN AGRESSIF CIBLÉ (CTF-perfect LEGACY) =====
  if [ -n "${ports:-}" ]; then
    echo "[2/4] Scan agressif sur les ports $ports..."

    # Variante LEGACY : scripts utiles en CTF + vieux SSL/TLS
    local vuln_scripts
    vuln_scripts="http-vuln-* and not http-vuln-cve2017-1001000,http-shellshock,http-sql-injection,ssl-cert,ssl-heartbleed,sslv2,ssl-dh-params"

    # Commande nmap (pour rappel dans l'en-tête)
    local scan_cmd
    scan_cmd="nmap -Pn -A -sV -p\"$ports\" --script=\"$vuln_scripts\" --script-timeout=30s -T4 \"$target\""

    # 1. Lancer le scan complet dans un fichier temporaire
    local temp_file
    temp_file="$output_dir/aggressive_vuln_scan_raw.txt"

    nmap -Pn -A -sV -p"$ports" \
      --script="$vuln_scripts" \
      --script-timeout=30s \
      -T4 \
      -oN "$temp_file" \
      "$target"

    # 2. Créer un fichier final avec un en-tête + le résultat brut
    {
      echo "[+] Scan agressif orienté vulnérabilités (CTF-perfect LEGACY) pour $target"
      echo "[+] Commande utilisée :"
      echo "    $scan_cmd"
      echo
      cat "$temp_file"
    } > "$output_dir/aggressive_vuln_scan.txt"

    # 3. Nettoyer le fichier temporaire
    rm -f "$temp_file"
  else
    echo "⚠️  Aucun port TCP ouvert détecté. Scan agressif ignoré."
  fi

  # ===== ÉTAPE 4: SCAN CIBLÉ CMS =====
  if [ -n "${ports:-}" ]; then
    echo "[3/4] Scan orienté CMS sur les ports $ports..."
    local cms_scripts
    cms_scripts="http-wordpress-enum,http-wordpress-brute,http-wordpress-users,http-drupal-enum,http-drupal-enum-users,http-joomla-brute,http-generator,http-robots.txt,http-title,http-headers,http-methods,http-enum,http-devframework,http-cakephp-version,http-php-version,http-config-backup,http-backup-finder,http-sitemap-generator"

    nmap -Pn -sV -p"$ports" \
      --script="$cms_scripts" \
      --script-timeout=30s \
      -T4 \
      -oN "$output_dir/cms_vuln_scan.txt" \
      "$target"
  fi

  # ===== ÉTAPE 5: SCAN UDP CIBLÉ =====
  echo "[4/4] Scan UDP (top 20 ports)..."
  nmap -n -Pn -sU --top-ports 20 -T4 -oN "$output_dir/udp_vuln_scan.txt" "$target"

  echo "✅ Scans terminés. Résultats du scan agressif dans $output_dir/aggressive_vuln_scan.txt"
}
# ---------------------------------------------------------------------------

# ---------------------------------------------------------------------------
# Parsing minimal CLI
DEBUG=false

# Aides rapides
if [[ "${1:-}" == "--version" || "${1:-}" == "-V" ]]; then
  _print_version_and_exit
fi
if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
  _version_str
  usage
  exit 0
fi

while [[ $# -gt 0 ]]; do
  case "$1" in
    --debug) DEBUG=true; shift ;;
    -V|--version) _print_version_and_exit ;;
    -h|--help)
      _version_str
      usage
      exit 0
      ;;
    --) shift; break ;;
    -*) echo "Unknown option: $1" >&2; usage; exit 2 ;;
    *) break ;;
  esac
done
# ---------------------------------------------------------------------------

_main(){
  if [ "$DEBUG" = true ]; then set -x; fi

  if [[ $# -lt 1 ]]; then
    echo "❌ Usage: ${_self_base} <IP_OU_DOMAINE>" >&2
    echo
    usage
    exit 1
  fi

  local target="$1"
  run_scans "$target"
}

if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
  _main "$@"
fi
