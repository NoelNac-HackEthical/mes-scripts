#!/bin/bash
# NAME=mon-subdomains
# VERSION=1.0.0
# DESCRIPTION=Découverte de sous-domaines par vhost-fuzzing (ffuf) avec baseline anti-wildcard, modes fast/medium/large et options d'ajout dans /etc/hosts.
# PRESENTATION_START
# **mon-subdomains — Découverte de vhosts pour CTF / pentest**
#
# Ce script automatise la recherche de sous-domaines en se basant sur du vhost-fuzzing :
# il teste des noms Host.FQDN en interrogeant l'IP cible via ffuf et extrait les hôtes
# valides (ex. api.mon-site.htb, admin.mon-site.htb). La recherche se fait soit à partir
# d'une "master" orientée HTB soit via une wordlist custom.
#
# PRESENTATION_END

set -euo pipefail
LC_ALL=C

# --- version helpers ---
_self_path="${BASH_SOURCE[0]:-$0}"
if command -v readlink >/dev/null 2>&1; then
  _resolved="$(readlink -f -- "$_self_path" 2>/dev/null || true)"
  [ -n "$_resolved" ] && _self_path="$_resolved"
fi
_self_base="$(basename "$_self_path")"

_version_str() {
  local v
  v="$(awk -F= '/^# *VERSION *=/ { gsub(/\r$/,"",$2); print $2; exit }' "$_self_path" 2>/dev/null || true)"
  [ -n "$v" ] || v="0.0.0"
  printf '%s %s\n' "$_self_base" "$v"
}

_print_version_and_exit() { _version_str; exit 0; }

# --- UI helpers ---
GREEN="\e[32m"; BLUE="\e[34m"; YELLOW="\e[33m"; RESET="\e[0m"
ok(){ echo -e "${GREEN}[✓]${RESET} $*"; }
info(){ echo -e "${BLUE}[*]${RESET} $*"; }
warn(){ echo -e "${YELLOW}[!]${RESET} $*"; }

usage(){
  cat <<'USAGE'
Usage:
  mon-subdomains <domaine.htb> [mode] [options]

Modes :
  -f, --fast      1000 premières lignes de la master
  -m, --medium    2000 premières lignes
  -l, --large     5000 (entière)
  --custom FILE   Wordlist personnalisée (ignore la master)
USAGE
}

# ---------- Fichier global ----------
MES_SCANS_DIR="mes_scans"
mkdir -p "$MES_SCANS_DIR"
SCAN_FILE="${MES_SCANS_DIR}/scan_vhosts.txt"
ok "Fichier de résultats : ${SCAN_FILE}"

# ----------- Parse ----------
if [[ "${1-}" == "-V" || "${1-}" == "--version" ]]; then _print_version_and_exit; fi

DOMAIN="${1-}"
if [[ -z "${DOMAIN}" ]]; then usage; exit 0; fi
shift || true

MODE="fast"; WL=""; THREADS=50; TIMEOUT=8
FORCE_HTTPS=0; DEBUG=0; SAVE_HOSTS=0; DRY_RUN_HOSTS=0
MASTER="/usr/share/wordlists/htb-dns-vh-5000.txt"
STRICT=0
MATCH_CODES="all"

while (( "$#" )); do
  case "$1" in
    -f|--fast) MODE="fast"; shift;;
    -m|--medium) MODE="medium"; shift;;
    -l|--large) MODE="large"; shift;;
    --custom) WL="${2-}"; MODE="custom"; shift 2;;
    --master) MASTER="${2-}"; shift 2;;
    -t) THREADS="${2-}"; shift 2;;
    --timeout) TIMEOUT="${2-}"; shift 2;;
    --https) FORCE_HTTPS=1; shift;;
    --strict) STRICT=1; shift;;
    --codes) MATCH_CODES="${2-}"; shift 2;;
    --save-hosts) SAVE_HOSTS=1; shift;;
    --dry-run-hosts) DRY_RUN_HOSTS=1; shift;;
    --debug) DEBUG=1; shift;;
    *) warn "Option inconnue: $1"; usage; exit 1;;
  esac
done

ok "Domaine : ${DOMAIN}"

command -v ffuf >/dev/null || { warn "ffuf manquant"; exit 1; }
command -v curl >/dev/null || { warn "curl manquant"; exit 1; }

# ---------- Gestion wordlist (avec génération interactive) ----------
WL_EFFECTIVE=""
if [[ "$MODE" == "custom" ]]; then
  [[ -f "$WL" ]] || { warn "Wordlist custom introuvable : $WL"; exit 1; }
  WL_EFFECTIVE="$WL"
  ok "Mode : CUSTOM (wordlist $WL_EFFECTIVE)"
else
  if [[ ! -f "$MASTER" ]]; then
    if [[ "$MASTER" == "/usr/share/wordlists/htb-dns-vh-5000.txt" ]]; then
      warn "Wordlist HTB introuvable : $MASTER"
      echo "Cette wordlist contient ~5000 noms de vhosts typiques HTB (admin, api, dev...)."
      echo "Elle est utilisée par --fast / --medium / --large."
      echo

      if command -v make-htb-wordlist >/dev/null 2>&1; then
        read -r -p "Générer la wordlist maintenant avec 'make-htb-wordlist' ? [o/N] " rep
        case "$rep" in
          [oOyY])
            info "Lancement de make-htb-wordlist..."
            if ! make-htb-wordlist; then
              warn "Échec de make-htb-wordlist"
              exit 1
            fi

            if [[ ! -f "$MASTER" ]]; then
              warn "make-htb-wordlist exécuté, mais le fichier $MASTER est introuvable."
              exit 1
            fi
            ;;
          *)
            warn "Wordlist requise. Exécute : make-htb-wordlist"
            exit 1
            ;;
        esac
      else
        warn "make-htb-wordlist introuvable dans le PATH."
        echo "Génère la wordlist manuellement, puis relance."
        exit 1
      fi
    else
      warn "Wordlist master introuvable : $MASTER"
      exit 1
    fi
  fi

  case "$MODE" in
    fast) N=1000;;
    medium) N=2000;;
    large) N=5000;;
  esac

  WL_EFFECTIVE="$(mktemp "/tmp/mon-subdomains_${DOMAIN}_wl.XXXXXX")"
  head -n "$N" "$MASTER" > "$WL_EFFECTIVE"
  ok "Mode $(echo "$MODE" | tr a-z A-Z) — wordlist effective : $WL_EFFECTIVE"
fi

# ---------- IP ----------
TARGET_IP="$(getent hosts "$DOMAIN" | awk '{print $1}' | head -n1 || true)"
[[ -z "$TARGET_IP" ]] && TARGET_IP="$(dig +short A "$DOMAIN" | head -n1 || true)"
[[ -n "$TARGET_IP" ]] && ok "IP détectée : $TARGET_IP" || warn "Aucune IP détectée"

# ---------- HTTP/HTTPS ----------
SCHEME="http"; PORT=80; CURL_TLS=""
probe(){ curl -sk --max-time "$TIMEOUT" -o /dev/null -w "%{http_code}" "$1" || true; }

if [[ $FORCE_HTTPS -eq 1 ]]; then
  SCHEME="https"; PORT=443; CURL_TLS="--insecure"
else
  if [[ "$(probe http://${DOMAIN}:80/)" == "000" && "$(probe https://${DOMAIN}:443/)" != "000" ]]; then
    SCHEME="https"; PORT=443; CURL_TLS="--insecure"
  fi
fi
ok "Schéma : ${SCHEME}  Port : ${PORT}"

# ---------- Fichiers temporaires ----------
FFUF_RAW="$(mktemp)"
VHOST_TXT="$(mktemp)"
: > "$VHOST_TXT"

# ---------- Baseline ----------
BASE_HOST="$(tr -dc 'a-z0-9' </dev/urandom | head -c 10)"
BASE_URL="${SCHEME}://${TARGET_IP}:${PORT}/"

BASE_RESP="$(curl -sk ${CURL_TLS:-} -H "Host: ${BASE_HOST}.${DOMAIN}" --max-time "$TIMEOUT" \
  -o /dev/null -w "%{http_code} %{size_download}" "$BASE_URL" || true)"

BASE_CODE="${BASE_RESP%% *}"
BASE_SIZE="${BASE_RESP##* }"
BASE_WORDS="$(curl -sk ${CURL_TLS:-} -H "Host: ${BASE_HOST}.${DOMAIN}" "$BASE_URL" | wc -w | tr -d ' ')"

info "Baseline : code=$BASE_CODE size=$BASE_SIZE words=$BASE_WORDS"

# ---------- Parseur ffuf ----------
extract_tokens_file() {
  awk -v d="$DOMAIN" '
    { gsub(/\033\[[0-9;]*[A-Za-z]/,"",$0) }
    /Status:/ {
      if (match($0,/([a-z0-9-]{1,63})[[:space:]]*$/,m))
        print m[1]"."d
    }
  ' "$1" | sort -u
}

# ---------- Fuzz ----------
if [[ -n "${TARGET_IP-}" ]]; then
  info "Scan VHOST…"

  FFUF_FILTER=()
  [[ "$BASE_SIZE" != "0" ]] && FFUF_FILTER+=(-fs "$BASE_SIZE")
  [[ "$BASE_WORDS" != "0" ]] && FFUF_FILTER+=(-fw "$BASE_WORDS")

  CMD=(ffuf -u "${SCHEME}://${TARGET_IP}:${PORT}/" \
       -H "Host: FUZZ.${DOMAIN}" -w "$WL_EFFECTIVE" \
       -t "$THREADS" -mc "$MATCH_CODES" "${FFUF_FILTER[@]}")

  [[ $DEBUG -eq 1 ]] && echo "CMD: ${CMD[*]}"
  "${CMD[@]}" > "$FFUF_RAW" 2>&1 || true

  extract_tokens_file "$FFUF_RAW" > "$VHOST_TXT"
else
  warn "Pas d’IP → pas de fuzz VHOST."
fi

VHOST_COUNT="$(grep -c . "$VHOST_TXT" || true)"
ok "$VHOST_COUNT vhosts trouvés"

# ---------- /etc/hosts ----------
if [[ $SAVE_HOSTS -eq 1 || $DRY_RUN_HOSTS -eq 1 ]]; then
  if [[ $VHOST_COUNT -eq 0 ]]; then warn "Aucun vhost → rien à ajouter."; fi

  if [[ -z "${TARGET_IP-}" ]]; then warn "IP inconnue → pas d'ajout hosts"; fi

  if [[ $DRY_RUN_HOSTS -eq 1 ]]; then
    info "[DRY RUN] Entrées /etc/hosts :"
    while read -r h; do echo "$TARGET_IP $h"; done < "$VHOST_TXT"
  else
    TS="$(date +%Y%m%d-%H%M%S)"
    sudo cp /etc/hosts "/etc/hosts.bak.${TS}"
    while read -r h; do
      if ! grep -qw "$h" /etc/hosts; then
        echo "$TARGET_IP $h" | sudo tee -a /etc/hosts >/dev/null
      fi
    done < "$VHOST_TXT"
  fi
fi

# ---------- Mise à jour du fichier global ----------
BLOCK_START="=== mon-subdomains ${DOMAIN} START ==="
BLOCK_END="=== mon-subdomains ${DOMAIN} END ==="

if [[ -f "$SCAN_FILE" ]]; then
  sed "/^=== mon-subdomains ${DOMAIN} START ===\$/,/^=== mon-subdomains ${DOMAIN} END ===\$/d" \
    "$SCAN_FILE" > "${SCAN_FILE}.tmp" || true
  mv "${SCAN_FILE}.tmp" "$SCAN_FILE"
fi

{
  echo "$BLOCK_START"
  echo "Script: mon-subdomains  Version: $(_version_str)"
  echo "Date: $(date '+%F %T')"
  echo "Domaine: $DOMAIN"
  echo "IP: ${TARGET_IP:-non détectée}"
  echo "Schéma/Port: $SCHEME/$PORT"
  echo "Mode: $MODE"
  echo "Wordlist effective: $WL_EFFECTIVE"
  echo "Master: $MASTER"
  echo "VHOST ($VHOST_COUNT):"
  sed 's/^/  - /' "$VHOST_TXT"
  echo "$BLOCK_END"
  echo
} >> "$SCAN_FILE"

ok "Bloc ajouté dans : $SCAN_FILE"

exit 0
